// Onyx Report - Complete Prisma Schema
// Based on Spec Section 3.1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ORGANIZATION & USERS
// ============================================

model Organization {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String    @db.VarChar(255)
  slug               String    @unique @db.VarChar(100)
  settings           Json      @default("{}")
  subscriptionTier   String    @default("starter") @map("subscription_tier") @db.VarChar(50)
  subscriptionStatus String    @default("active") @map("subscription_status") @db.VarChar(50)
  maxBuildings       Int       @default(25) @map("max_buildings")
  maxUsers           Int       @default(10) @map("max_users")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  branches    Branch[]
  buildings   Building[]
  users       User[]
  assessments Assessment[]
  photos      Photo[]

  @@map("organizations")
}

model User {
  id              String    @id @default(uuid()) @db.Uuid
  organizationId  String    @map("organization_id") @db.Uuid
  auth0Id         String?   @unique @map("auth0_id") @db.VarChar(255)
  email           String    @db.VarChar(255)
  firstName       String?   @map("first_name") @db.VarChar(100)
  lastName        String?   @map("last_name") @db.VarChar(100)
  role            UserRole
  phone           String?   @db.VarChar(50)
  avatarUrl       String?   @map("avatar_url") @db.VarChar(500)
  isActive        Boolean   @default(true) @map("is_active")
  lastLoginAt     DateTime? @map("last_login_at")
  inviteToken     String?   @unique @map("invite_token") @db.VarChar(255)
  inviteExpiresAt        DateTime? @map("invite_expires_at")
  passwordHash           String?   @map("password_hash") @db.VarChar(255)
  passwordResetToken     String?   @unique @map("password_reset_token") @db.VarChar(255)
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  organization        Organization         @relation(fields: [organizationId], references: [id])
  userBranches        UserBranch[]
  createdAssessments  Assessment[]         @relation("AssessmentCreator")
  approvedAssessments Assessment[]         @relation("AssessmentApprover")
  assignedAssessments AssessmentAssignee[]
  assessedElements    AssessmentElement[]
  createdDeficiencies Deficiency[]
  uploadedPhotos      Photo[]
  syncQueueItems      SyncQueue[]
  auditLogs           AuditLog[]

  @@unique([organizationId, email])
  @@map("users")
}

enum UserRole {
  org_admin
  branch_manager
  assessor
  viewer
}

model UserBranch {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  branchId  String   @map("branch_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([userId, branchId])
  @@map("user_branches")
}

// ============================================
// BRANCHES & BUILDINGS
// ============================================

model Branch {
  id             String    @id @default(uuid()) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  code           String?   @db.VarChar(50)
  addressLine1   String?   @map("address_line1") @db.VarChar(255)
  addressLine2   String?   @map("address_line2") @db.VarChar(255)
  city           String?   @db.VarChar(100)
  state          String?   @db.VarChar(100)
  postalCode     String?   @map("postal_code") @db.VarChar(20)
  country        String    @default("USA") @db.VarChar(100)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  organization Organization  @relation(fields: [organizationId], references: [id])
  buildings    Building[]
  assessments  Assessment[]
  userBranches UserBranch[]

  @@unique([organizationId, name])
  @@map("branches")
}

model Building {
  id                       String    @id @default(uuid()) @db.Uuid
  organizationId           String    @map("organization_id") @db.Uuid
  branchId                 String    @map("branch_id") @db.Uuid
  name                     String    @db.VarChar(255)
  code                     String?   @db.VarChar(50)
  addressLine1             String?   @map("address_line1") @db.VarChar(255)
  addressLine2             String?   @map("address_line2") @db.VarChar(255)
  city                     String?   @db.VarChar(100)
  state                    String?   @db.VarChar(100)
  postalCode               String?   @map("postal_code") @db.VarChar(20)
  country                  String    @default("USA") @db.VarChar(100)
  yearBuilt                Int?      @map("year_built")
  grossSquareFeet          Decimal?  @map("gross_square_feet") @db.Decimal(12, 2)
  currentReplacementValue  Decimal?  @map("current_replacement_value") @db.Decimal(15, 2)
  buildingType             String?   @map("building_type") @db.VarChar(100)
  numFloors                Int?      @map("num_floors")
  description              String?   @db.Text
  latitude                 Decimal?  @db.Decimal(10, 8)
  longitude                Decimal?  @db.Decimal(11, 8)
  imageUrl                 String?   @map("image_url") @db.VarChar(500)
  // Calculated fields
  currentFci               Decimal   @default(0) @map("current_fci") @db.Decimal(5, 4)
  totalDeferredMaintenance Decimal   @default(0) @map("total_deferred_maintenance") @db.Decimal(15, 2)
  lastAssessmentDate       DateTime? @map("last_assessment_date")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  createdBy                String?   @map("created_by") @db.Uuid
  updatedBy                String?   @map("updated_by") @db.Uuid
  deletedAt                DateTime? @map("deleted_at")

  organization Organization  @relation(fields: [organizationId], references: [id])
  branch       Branch        @relation(fields: [branchId], references: [id])
  assessments  Assessment[]
  photos       Photo[]

  @@unique([branchId, name])
  @@index([organizationId])
  @@index([branchId])
  @@index([currentFci])
  @@map("buildings")
}

// ============================================
// ASSESSMENTS
// ============================================

model Assessment {
  id                       String           @id @default(uuid()) @db.Uuid
  organizationId           String           @map("organization_id") @db.Uuid
  branchId                 String           @map("branch_id") @db.Uuid
  buildingId               String           @map("building_id") @db.Uuid
  name                     String           @db.VarChar(255)
  description              String?          @db.Text
  status                   AssessmentStatus @default(draft)
  targetCompletionDate     DateTime?        @map("target_completion_date") @db.Date
  startedAt                DateTime?        @map("started_at")
  submittedAt              DateTime?        @map("submitted_at")
  approvedAt               DateTime?        @map("approved_at")
  approvedById             String?          @map("approved_by") @db.Uuid
  rejectionReason          String?          @map("rejection_reason") @db.Text
  // Calculated fields
  totalElements            Int              @default(0) @map("total_elements")
  completedElements        Int              @default(0) @map("completed_elements")
  totalDeficiencies        Int              @default(0) @map("total_deficiencies")
  totalDeferredMaintenance Decimal          @default(0) @map("total_deferred_maintenance") @db.Decimal(15, 2)
  calculatedFci            Decimal?         @map("calculated_fci") @db.Decimal(5, 4)
  createdAt                DateTime         @default(now()) @map("created_at")
  updatedAt                DateTime         @updatedAt @map("updated_at")
  createdById              String?          @map("created_by") @db.Uuid
  updatedBy                String?          @map("updated_by") @db.Uuid
  deletedAt                DateTime?        @map("deleted_at")

  organization Organization          @relation(fields: [organizationId], references: [id])
  branch       Branch                @relation(fields: [branchId], references: [id])
  building     Building              @relation(fields: [buildingId], references: [id])
  createdBy    User?                 @relation("AssessmentCreator", fields: [createdById], references: [id])
  approvedBy   User?                 @relation("AssessmentApprover", fields: [approvedById], references: [id])
  assignees    AssessmentAssignee[]
  elements     AssessmentElement[]

  @@index([organizationId])
  @@index([buildingId])
  @@index([status])
  @@map("assessments")
}

enum AssessmentStatus {
  draft
  in_progress
  submitted
  in_review
  approved
  rejected
}

model AssessmentAssignee {
  id           String   @id @default(uuid()) @db.Uuid
  assessmentId String   @map("assessment_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  assignedAt   DateTime @default(now()) @map("assigned_at")
  assignedById String?  @map("assigned_by") @db.Uuid

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@unique([assessmentId, userId])
  @@map("assessment_assignees")
}

// ============================================
// UNIFORMAT & ELEMENTS
// ============================================

model UniformatElement {
  id                   String  @id @default(uuid()) @db.Uuid
  code                 String  @unique @db.VarChar(20)
  name                 String  @db.VarChar(255)
  description          String? @db.Text
  systemGroup          String  @map("system_group") @db.VarChar(100)
  level                Int     @db.SmallInt
  parentCode           String? @map("parent_code") @db.VarChar(20)
  defaultLifetimeYears Int?    @map("default_lifetime_years")
  defaultUnitOfMeasure String? @map("default_unit_of_measure") @db.VarChar(50)
  isActive             Boolean @default(true) @map("is_active")
  sortOrder            Int?    @map("sort_order")

  assessmentElements AssessmentElement[]

  @@index([systemGroup])
  @@index([level])
  @@map("uniformat_elements")
}

model AssessmentElement {
  id                   String        @id @default(uuid()) @db.Uuid
  assessmentId         String        @map("assessment_id") @db.Uuid
  uniformatElementId   String        @map("uniformat_element_id") @db.Uuid
  // Type Fields 1-3: Identity
  systemName           String?       @map("system_name") @db.VarChar(255)
  uniformatCode        String        @map("uniformat_code") @db.VarChar(20)
  systemGroup          String        @map("system_group") @db.VarChar(100)
  // Type Fields 4-6: Lifecycle
  lifetimeYears        Int?          @map("lifetime_years")
  yearInstalled        Int?          @map("year_installed")
  remainingUsefulLife  Int?          @map("remaining_useful_life")
  // Type Fields 7-8: Quantity
  unitOfMeasure        String?       @map("unit_of_measure") @db.VarChar(50)
  quantity             Decimal?      @db.Decimal(12, 2)
  // Type Fields 9-11: Location
  locationDescription  String?       @map("location_description") @db.Text
  floor                String?       @db.VarChar(50)
  room                 String?       @db.VarChar(100)
  // Type Fields 12-15: Equipment
  manufacturer         String?       @db.VarChar(255)
  model                String?       @db.VarChar(255)
  serialNumber         String?       @map("serial_number") @db.VarChar(255)
  assetId              String?       @map("asset_id") @db.VarChar(255)
  // Type Fields 16-18: Financial
  costPerUnit          Decimal?      @map("cost_per_unit") @db.Decimal(12, 2)
  renewalFactor        Decimal       @default(1.0) @map("renewal_factor") @db.Decimal(5, 2)
  totalReplacementCost Decimal?      @map("total_replacement_cost") @db.Decimal(15, 2)
  // Condition Assessment
  conditionRating      Int?          @map("condition_rating") @db.SmallInt
  conditionNotes       String?       @map("condition_notes") @db.Text
  // Status
  status               ElementStatus @default(pending)
  assessedAt           DateTime?     @map("assessed_at")
  assessedById         String?       @map("assessed_by") @db.Uuid
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  deletedAt            DateTime?     @map("deleted_at")

  assessment       Assessment       @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  uniformatElement UniformatElement @relation(fields: [uniformatElementId], references: [id])
  assessedBy       User?            @relation(fields: [assessedById], references: [id])
  deficiencies     Deficiency[]
  photos           Photo[]

  @@index([assessmentId])
  @@index([uniformatCode])
  @@index([status])
  @@map("assessment_elements")
}

enum ElementStatus {
  pending
  in_progress
  completed
  skipped
}

// ============================================
// DEFICIENCIES
// ============================================

model DeficiencyCategory {
  id          String  @id @default(uuid()) @db.Uuid
  code        String  @unique @db.VarChar(50)
  name        String  @db.VarChar(255)
  description String? @db.Text
  color       String? @db.VarChar(7)
  sortOrder   Int?    @map("sort_order")
  isActive    Boolean @default(true) @map("is_active")

  deficiencies Deficiency[]

  @@map("deficiency_categories")
}

model Deficiency {
  id                  String             @id @default(uuid()) @db.Uuid
  assessmentElementId String             @map("assessment_element_id") @db.Uuid
  categoryId          String?            @map("category_id") @db.Uuid
  title               String             @db.VarChar(255)
  description         String?            @db.Text
  priority            DeficiencyPriority @default(medium_term)
  severity            DeficiencySeverity @default(moderate)
  estimatedCost       Decimal?           @map("estimated_cost") @db.Decimal(12, 2)
  quantity            Decimal            @default(1) @db.Decimal(12, 2)
  unitOfMeasure       String?            @map("unit_of_measure") @db.VarChar(50)
  totalCost           Decimal?           @map("total_cost") @db.Decimal(15, 2)
  recommendedAction   String?            @map("recommended_action") @db.Text
  targetYear          Int?               @map("target_year")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")
  createdById         String?            @map("created_by") @db.Uuid
  deletedAt           DateTime?          @map("deleted_at")

  assessmentElement AssessmentElement   @relation(fields: [assessmentElementId], references: [id], onDelete: Cascade)
  category          DeficiencyCategory? @relation(fields: [categoryId], references: [id])
  createdBy         User?               @relation(fields: [createdById], references: [id])
  photos            Photo[]

  @@index([assessmentElementId])
  @@index([priority])
  @@map("deficiencies")
}

enum DeficiencyPriority {
  immediate   // 0-1 years
  short_term  // 1-3 years
  medium_term // 3-5 years
  long_term   // 5-10 years
}

enum DeficiencySeverity {
  minor
  moderate
  major
  critical
}

// ============================================
// PHOTOS
// ============================================

model Photo {
  id                  String    @id @default(uuid()) @db.Uuid
  organizationId      String    @map("organization_id") @db.Uuid
  buildingId          String?   @map("building_id") @db.Uuid
  assessmentElementId String?   @map("assessment_element_id") @db.Uuid
  deficiencyId        String?   @map("deficiency_id") @db.Uuid
  filename            String    @db.VarChar(255)
  originalFilename    String?   @map("original_filename") @db.VarChar(255)
  mimeType            String?   @map("mime_type") @db.VarChar(100)
  fileSize            Int?      @map("file_size")
  s3Key               String    @map("s3_key") @db.VarChar(500)
  s3Bucket            String    @map("s3_bucket") @db.VarChar(255)
  thumbnailS3Key      String?   @map("thumbnail_s3_key") @db.VarChar(500)
  caption             String?   @db.Text
  sortOrder           Int?      @map("sort_order") @db.SmallInt
  latitude            Decimal?  @db.Decimal(10, 8)
  longitude           Decimal?  @db.Decimal(11, 8)
  takenAt             DateTime? @map("taken_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  uploadedById        String?   @map("uploaded_by") @db.Uuid
  deletedAt           DateTime? @map("deleted_at")

  organization      Organization       @relation(fields: [organizationId], references: [id])
  building          Building?          @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  assessmentElement AssessmentElement? @relation(fields: [assessmentElementId], references: [id], onDelete: Cascade)
  deficiency        Deficiency?        @relation(fields: [deficiencyId], references: [id], onDelete: Cascade)
  uploadedBy        User?              @relation(fields: [uploadedById], references: [id])

  @@index([buildingId])
  @@index([assessmentElementId])
  @@index([deficiencyId])
  @@map("photos")
}

// ============================================
// SYNC (Offline Support)
// ============================================

model SyncQueue {
  id          String     @id @default(uuid()) @db.Uuid
  userId      String     @map("user_id") @db.Uuid
  entityType  String     @map("entity_type") @db.VarChar(50)
  entityId    String     @map("entity_id") @db.Uuid
  operation   String     @db.VarChar(20)
  payload     Json
  status      SyncStatus @default(pending)
  attempts    Int        @default(0)
  lastError   String?    @map("last_error") @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")
  processedAt DateTime?  @map("processed_at")

  user User @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([userId])
  @@map("sync_queue")
}

enum SyncStatus {
  pending
  processing
  completed
  failed
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  action         String   @db.VarChar(50)
  entityType     String?  @map("entity_type") @db.VarChar(50)
  entityId       String?  @map("entity_id") @db.Uuid
  metadata       Json?    @default("{}")
  ipAddress      String?  @map("ip_address") @db.VarChar(45)
  userAgent      String?  @map("user_agent") @db.VarChar(500)
  createdAt      DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
